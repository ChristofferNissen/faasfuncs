arch: arm64
os: linux
dist: xenial
language: ruby
services:
  - docker

before_install: 
  # check archicture. .com does not support arm atm.
  - dpkg --print-architecture
  
  # installing newer docker
  - sudo apt-get update
  
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
  
  # installing the faas-cli
  - curl -sSL https://cli.openfaas.com | sudo sh

jobs:
  include:
    - stage: login
      script:
        - echo -n $OPENFAAS_PASS | faas-cli login --username admin --password-stdin -g https://gateway.christoffernissen.me

          # - echo -n $INFLUX_USER | faas-cli secret create influx-user -g https://gateway.christoffernissen.me
          # - echo -n $INFLUX_PASS | faas-cli secret create influx-pass -g https://gateway.christoffernissen.me

          # - faas-cli up -f iot/iot-assignment2.yml --env write_debug=true
          # - faas-cli up -f iot/iot-ml-func.yml --env write_debug=true
      - stage: build ml func
        script: faas-cli build -f iot/iot-ml-func.yml
      - stage: build ml func
        script: faas-cli push -f iot/iot-ml-func.yml 
      - stage: build ml func
        script: faas-cli deploy -f iot/iot-ml-func.yml --env write_debug=true
      
      - stage: mqtt helper
        script:
          - docker build -f iot/helper/Dockerfile iot/helper -t stifstof/iotmqttinterceptor
          - docker push stifstof/iotmqttinterceptor:latest

  # kubectl run --image=stifstof/iotmqttinterceptor iotmqttinterceptor-app --env="mqtt-pass="
  
